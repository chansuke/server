#
# MDEV-7937: Enforce SSL when --ssl client option is used
#

source include/have_ssl_crypto_functs.inc;

# create a procedure instead of SHOW STATUS LIKE 'ssl_cipher'
# because the cipher depends on openssl (or yassl) version,
# and it's actual value doesn't matter here anyway
create procedure have_ssl()
  select if(variable_value > '','yes','no') as 'have_ssl'
  from information_schema.session_status
  where variable_name='ssl_cipher';

--echo #
--echo # MDEV-28634 Client's --ssl-* options (without --ssl-verify-server-cert) are silently ignored if TLS is not possible
--echo #
--echo mysql --ssl-verify-server-cert=0 --autoset-ssl-verify-server-cert --ssl -e "call test.have_ssl()"
--error 1
--exec $MYSQL --ssl-verify-server-cert=0 --autoset-ssl-verify-server-cert --ssl -e "call test.have_ssl()" 2>&1
--echo mysql --autoset-ssl-verify-server-cert --ssl-ca=cacert.pem -e "call test.have_ssl()"
--exec $MYSQL --autoset-ssl-verify-server-cert --ssl-ca=$MYSQL_TEST_DIR/std_data/cacert.pem -e "call test.have_ssl()" 2>&1
--echo mysql --skip-ssl --ssl-verify-server-cert=1 --autoset-ssl-verify-server-cert -e "call test.have_ssl()"
--exec $MYSQL --skip-ssl --ssl-verify-server-cert=1 --autoset-ssl-verify-server-cert -e "call test.have_ssl()" 2>&1

drop procedure have_ssl;
